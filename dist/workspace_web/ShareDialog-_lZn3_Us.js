import{r as n,j as e,i as v,M as q,N as X,O as Z,Q as ee,S as oe}from"./input.js";import{h as te,B as se,K as ne,ae,H as b,l as W,ac as re,ab as P,j as ie,p as N,k as B,aL as le,o as ce,F as de,aM as ue,C as j,aN as C,aO as he,aP as fe,aQ as we,T as ge,aR as pe}from"./App-C3wcRiQu.js";import{app as xe}from"/scripts/app.js";import{a as K,R as me,L as je}from"./chunk-RDF2AYID-V8_50VEk.js";import{I as ve}from"./IconCopy-D2M_jmzt.js";import"/scripts/api.js";import"./index-DdrsuNi1.js";var ke=te("cloud","IconCloud",[["path",{d:"M6.657 18c-2.572 0 -4.657 -2.007 -4.657 -4.483c0 -2.475 2.085 -4.482 4.657 -4.482c.393 -1.762 1.794 -3.2 3.675 -3.773c1.88 -.572 3.956 -.193 5.444 1c1.488 1.19 2.162 3.007 1.77 4.769h.99c1.913 0 3.464 1.56 3.464 3.486c0 1.927 -1.551 3.487 -3.465 3.487h-11.878",key:"svg-0"}]]);function Ie({options:a,value:d,onChange:u}){const[s,h]=n.useState(!1),g=n.useRef(null),r=a.find(i=>i.value===d);n.useEffect(()=>{const i=x=>{g.current&&!g.current.contains(x.target)&&h(!1)};return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[g]);const p=()=>h(!s);return e.jsxs(se,{position:"relative",children:[e.jsx(v,{onClick:p,rightIcon:e.jsx(ne,{}),leftIcon:r==null?void 0:r.icon,children:r==null?void 0:r.label}),s&&e.jsx(ae,{gap:4,ref:g,mt:"2",shadow:"md",borderWidth:"1px",p:"2",position:"absolute",zIndex:100,children:a.map(i=>e.jsx(v,{onClick:()=>{h(!1),u(i.value)},leftIcon:i.icon,justifyContent:"flex-start",variant:"ghost",width:"full",children:i.label},i.label))})]})}function Se({version:a,cloudHost:d,cloudWorkflowID:u}){const s=a,h=e.jsxs(b,{spacing:4,alignItems:"center",children:[e.jsx(W,{children:s.name}),e.jsx(W,{color:"GrayText",children:re(s.createTime,!1)}),s.cloudID&&u&&e.jsx("a",{href:d+"/workflow/"+u+"/"+s.cloudID,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"},children:e.jsx(v,{size:"xs",colorScheme:"teal",variant:"outline",leftIcon:e.jsx(ke,{}),rightIcon:e.jsx(P,{size:18}),children:"Shared"})})]});return a.cloudID?e.jsx(e.Fragment,{children:h}):e.jsx(K,{value:s.id,mb:5,children:h},s.id)}function Le({onClose:a}){var M,V;const[d,u]=n.useState("v"+ye()),[s,h]=n.useState([]),[g,r]=n.useState(!1),[p,i]=n.useState(""),[x,E]=n.useState("PRIVATE"),[k,R]=n.useState("new_version"),T=n.useRef(""),[I,U]=n.useState(),A=ie(),L=async o=>{var S,y;const t=o.data;if(o.origin!==T.current||t.type!=="share_workflow_success")return;const f=t.localWorkflowID,l=t.localVersionID,w=t.version.id,c=t.version.workflowID;c&&f&&await((S=j)==null?void 0:S.updateMetaInfo(f,{cloudID:c,cloudOrigin:o.origin,privacy:x})),l&&w&&await((y=C)==null?void 0:y.update(l,{cloudID:w,cloudOrigin:o.origin})),_(),window.open(T.current+"/workflow/"+c+"/"+w,"_blank"),r(!1)};n.useEffect(()=>(_(),window.addEventListener("message",L),()=>{window.removeEventListener("message",L)}),[]);const _=async()=>{var f,l,w;const o=await((f=N)==null?void 0:f.getSetting("cloudHost"));o&&(i(o),T.current=o);const t=((l=j)==null?void 0:l.curWorkflow)??void 0;U(t),t!=null&&t.cloudID&&t.cloudOrigin&&we(t).then(c=>{E(c)}),(w=C)==null||w.listByWorkflowID(t.id).then(c=>{h(c)})},G=o=>{navigator.clipboard.writeText(o).then(()=>{A({title:"Copied to clipboard",status:"success",duration:2e3,isClosable:!0})}).catch(t=>{console.error("Failed to copy text: ",t)})},Q=async()=>{var O,F,$;r(!0);const o=he(32),t=await((O=N)==null?void 0:O.getSetting("cloudHost"));let f,l;try{if(f=fe(),k==="new_version"?l=await((F=C)==null?void 0:F.add({workflowID:I.id,name:d,createTime:Date.now(),json:JSON.stringify(xe.graph.serialize())})):l=await(($=C)==null?void 0:$.get(k)),!l){alert(`Failed to find version: ${k}, please try again.`),r(!1);return}}catch(D){console.error(D),r(!1),alert("Failed to share workflow, please try again.");return}const w=window.location.protocol,c=window.location.host,S=`${w}//${c}`,y=t+`/share_workflow_confirm/${o}?redirectUrl=${S}`,J=window.open(y,"Share Workflow","width=800,height=800"),H=D=>{var z;if(D.origin===t&&D.data==="child_ready"){const Y=(z=j)==null?void 0:z.curWorkflow;J.postMessage({workflow:Y,version:l,nodeDefs:f,privacy:x},t),window.removeEventListener("message",H)}};window.addEventListener("message",H)},m=(V=(M=j)==null?void 0:M.curWorkflow)==null?void 0:V.cloudID;return e.jsxs(q,{isOpen:!0,onClose:a,size:"lg",children:[e.jsx(X,{}),e.jsxs(Z,{width:["98%","90%","50%"],maxWidth:"600px",children:[e.jsxs(ee,{children:['Share "',I==null?void 0:I.name,'"']}),e.jsxs(oe,{pb:10,children:[e.jsxs(B,{gap:5,children:[m==null?e.jsx(Ie,{options:le,value:x,onChange:o=>{E(o)}}):e.jsx(ge,{variant:"outline",borderRadius:"full",width:"fit-content",children:e.jsx(pe,{privacy:x,showEmoji:!0})}),m&&e.jsxs(b,{spacing:2,color:"teal.400",children:[e.jsxs(je,{href:p+"/workflow/"+m,isExternal:!0,children:[p+"/workflow/"+m," ",e.jsx(P,{size:20,style:{display:"inline-block",verticalAlign:"middle"}})]}),e.jsx(v,{width:"180px",size:"sm",leftIcon:e.jsx(ve,{}),onClick:()=>{var o,t;G(p+"/workflow/"+((t=(o=j)==null?void 0:o.curWorkflow)==null?void 0:t.cloudID))},children:"Copy link"})]}),e.jsx(W,{children:"Choose a version to share:"}),e.jsx(me,{gap:4,onChange:o=>{R(o)},value:k,children:e.jsxs(B,{children:[e.jsxs(b,{mb:5,alignItems:"center",children:[e.jsx(K,{value:"new_version"},"new_version"),e.jsx(ce,{value:d,width:"60%",onFocus:()=>{R("new_version")},onChange:o=>{u(o.target.value)}}),e.jsx(de,{color:"green",children:e.jsx(ue,{colorScheme:"purple",children:"New version"})})]}),s.slice(0,4).map(o=>e.jsx(Se,{version:o,cloudHost:p,cloudWorkflowID:m??null},o.id))]})})]}),e.jsx(b,{justifyContent:"flex-end",mt:16,children:e.jsx(v,{colorScheme:"teal",onClick:Q,isDisabled:g,children:g?"Sharing":"Share"})})]})]})]})}function ye(){const a=new Date,d=a.getFullYear(),u=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${d}-${u}-${s}`}export{Le as default};
